name: Deploy Creditop Delete Account Web

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

env:
  FLUTTER_VERSION: '3.35.5'

jobs:
  build-and-deploy:
    name: Build & Deploy Flutter Web
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Create .env file
        run: |
          cat << EOF > app/.env
          COGNITO_REGION=us-east-2
          COGNITO_USER_POOL_ID=${{ secrets.COGNITO_USER_POOL_ID }}
          COGNITO_CLIENT_ID=${{ secrets.COGNITO_CLIENT_ID }}
          COGNITO_DOMAIN=${{ secrets.COGNITO_DOMAIN }}
          EOF
          # Crear .env.dev vacío (requerido por pubspec.yaml assets)
          touch app/.env.dev

      - name: Get dependencies (packages)
        run: |
          for pkg in core cds_web feature_auth feature_delete_account; do
            cd packages/$pkg && flutter pub get && cd ../..
          done

      - name: Get dependencies (app)
        working-directory: app
        run: flutter pub get

      - name: Generate code (packages)
        run: |
          for pkg in core cds_mobile feature_auth feature_credits feature_financial_health feature_home feature_splash feature_onboarding feature_user_profile; do
            cd packages/$pkg
            if grep -q "build_runner" pubspec.yaml; then
              flutter pub run build_runner build --delete-conflicting-outputs
            fi
            cd ../..
          done

      - name: Generate code (app)
        working-directory: app
        run: flutter pub run build_runner build --delete-conflicting-outputs

      - name: Build Web
        working-directory: app
        run: flutter build web --release --base-href "/" --tree-shake-icons

      - name: Remove debug symbols
        run: |
          rm -f app/build/web/canvaskit/*.symbols
          rm -f app/build/web/*.symbols
          echo "Removed debug symbol files"

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: us-east-2

      - name: Sync to S3
        run: |
          aws s3 sync app/build/web s3://${{ vars.S3_BUCKET_NAME }} \
            --delete \
            --cache-control "public, max-age=31536000"

          # HTML y JSON sin cache (siempre fresh)
          aws s3 cp app/build/web/index.html s3://${{ vars.S3_BUCKET_NAME }}/index.html \
            --cache-control "public, max-age=0, must-revalidate"

          aws s3 cp app/build/web/manifest.json s3://${{ vars.S3_BUCKET_NAME }}/manifest.json \
            --cache-control "public, max-age=0, must-revalidate"

          aws s3 cp app/build/web/flutter_bootstrap.js s3://${{ vars.S3_BUCKET_NAME }}/flutter_bootstrap.js \
            --cache-control "public, max-age=0, must-revalidate"

          # Service worker sin cache (crítico para actualizaciones)
          aws s3 cp app/build/web/flutter_service_worker.js s3://${{ vars.S3_BUCKET_NAME }}/flutter_service_worker.js \
            --cache-control "public, max-age=0, must-revalidate"

          # Version.json sin cache (contiene hash de versión)
          aws s3 cp app/build/web/version.json s3://${{ vars.S3_BUCKET_NAME }}/version.json \
            --cache-control "public, max-age=0, must-revalidate"

      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_ID }} \
            --paths "/*"
